<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Complete examples &mdash; Traits Futures 0.3.0.dev0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    <link rel="stylesheet" href="../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" >
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.3.0.dev0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        LINK_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../_static/js/wrap_on_dot.js"></script>
    <link rel="shortcut icon" href="../_static/img/favicon.ico">
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="Traits Futures 0.3.0.dev0 documentation" href="../index.html" >
    <link rel="next" title="traits_futures package" href="../api/traits_futures.html" >
    <link rel="prev" title="Advanced topics" href="advanced.html" > 
  </head>
  <body>
  <div class="container">
    <div class="header">
    </div>
  </div>

    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../index.html">Traits Futures 0.3.0.dev0 documentation</a></li>
	 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
      <li class="active">
        <a href="../api/traits_futures.html" title="traits_futures package"
           accesskey="N">next</a>
      </li>
      <li class="active">
        <a href="advanced.html" title="Advanced topics"
           accesskey="P">previous</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body" role="main">
            
  <section id="complete-examples">
<h1>Complete examples<a class="headerlink" href="#complete-examples" title="Permalink to this headline">¶</a></h1>
<p>This section describes three complete examples, that make use of the
three different background task types that Traits Futures currently supports.</p>
<section id="slow-squares">
<h2>Slow squares<a class="headerlink" href="#slow-squares" title="Permalink to this headline">¶</a></h2>
<img alt="Screenshot of the slow squares GUI in action" src="../_images/slow_squares.png" />
<p>This <a class="reference download internal" download="" href="../_downloads/121ba7323ad5ad1a617772fa502353b5/slow_squares.py"><code class="xref download docutils literal notranslate"><span class="pre">example</span> <span class="pre">script</span></code></a> demonstrates a
simple TraitsUI application that allows several background calculations to be
running simultaneously, and displays the state of all previously submitted
calculations in a table. Each “calculation” is a squaring operation; the
calculation may fail randomly, with an increased chance of failure for larger
inputs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (C) Copyright 2018-2021 Enthought, Inc., Austin, TX</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This software is provided without warranty under the terms of the BSD</span>
<span class="c1"># license included in LICENSE.txt and may be redistributed only under</span>
<span class="c1"># the conditions described in the aforementioned license. The license</span>
<span class="c1"># is also available online at http://www.enthought.com/licenses/BSD.txt</span>
<span class="c1">#</span>
<span class="c1"># Thanks for using Enthought open source!</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Button</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">HasStrictTraits</span><span class="p">,</span>
    <span class="n">Instance</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">observe</span><span class="p">,</span>
    <span class="n">Property</span><span class="p">,</span>
    <span class="n">Range</span><span class="p">,</span>
    <span class="n">Str</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CallFuture</span><span class="p">,</span>
    <span class="n">CANCELLED</span><span class="p">,</span>
    <span class="n">CANCELLING</span><span class="p">,</span>
    <span class="n">COMPLETED</span><span class="p">,</span>
    <span class="n">EXECUTING</span><span class="p">,</span>
    <span class="n">FAILED</span><span class="p">,</span>
    <span class="n">submit_call</span><span class="p">,</span>
    <span class="n">TraitsExecutor</span><span class="p">,</span>
    <span class="n">WAITING</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traitsui.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HGroup</span><span class="p">,</span>
    <span class="n">Item</span><span class="p">,</span>
    <span class="n">TabularAdapter</span><span class="p">,</span>
    <span class="n">TabularEditor</span><span class="p">,</span>
    <span class="n">UItem</span><span class="p">,</span>
    <span class="n">VGroup</span><span class="p">,</span>
    <span class="n">View</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">slow_square</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the square of an integer, slowly and unreliably.</span>

<span class="sd">    The input should be in the range 0-100. The larger</span>
<span class="sd">    the input, the longer the expected time to complete the operation,</span>
<span class="sd">    and the higher the likelihood of timeout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.0</span>
    <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">expovariate</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">mean_time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Calculation took too long.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">n</span>


<span class="k">class</span> <span class="nc">JobTabularAdapter</span><span class="p">(</span><span class="n">TabularAdapter</span><span class="p">):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;Job State&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1">#: Row colors for the table.</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">CANCELLED</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">CANCELLING</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">EXECUTING</span><span class="p">:</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="n">FAILED</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
            <span class="n">COMPLETED</span><span class="p">:</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="n">WAITING</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1">#: Text to be displayed for the state column.</span>
    <span class="n">state_text</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Str</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_get_bg_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">state</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_state_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span>
        <span class="n">state_text</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">COMPLETED</span><span class="p">:</span>
            <span class="n">state_text</span> <span class="o">+=</span> <span class="s2">&quot;: result=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">:</span>
            <span class="n">state_text</span> <span class="o">+=</span> <span class="s2">&quot;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">exception</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">state_text</span>


<span class="k">class</span> <span class="nc">SquaringHelper</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="c1">#: The Traits executor for the background jobs.</span>
    <span class="n">traits_executor</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">TraitsExecutor</span><span class="p">)</span>

    <span class="c1">#: List of the submitted jobs, for display purposes.</span>
    <span class="n">current_futures</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Instance</span><span class="p">(</span><span class="n">CallFuture</span><span class="p">))</span>

    <span class="c1">#: Start a new squaring operation.</span>
    <span class="n">square</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>

    <span class="c1">#: Cancel all currently executing jobs.</span>
    <span class="n">cancel_all</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>

    <span class="c1">#: Clear completed jobs from the list of current jobs.</span>
    <span class="n">clear_finished</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>

    <span class="c1">#: Value that we&#39;ll square.</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;square&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_slow_square</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">submit_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traits_executor</span><span class="p">,</span> <span class="n">slow_square</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;cancel_all&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_cancel_all_futures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_futures</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;clear_finished&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_clear_finished_futures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_futures</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_futures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">default_traits_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">View</span><span class="p">(</span>
            <span class="n">HGroup</span><span class="p">(</span>
                <span class="n">VGroup</span><span class="p">(</span>
                    <span class="n">Item</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">),</span>
                    <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;square&quot;</span><span class="p">),</span>
                    <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;cancel_all&quot;</span><span class="p">),</span>
                    <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;clear_finished&quot;</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">VGroup</span><span class="p">(</span>
                    <span class="n">UItem</span><span class="p">(</span>
                        <span class="s2">&quot;current_futures&quot;</span><span class="p">,</span>
                        <span class="n">editor</span><span class="o">=</span><span class="n">TabularEditor</span><span class="p">(</span>
                            <span class="n">adapter</span><span class="o">=</span><span class="n">JobTabularAdapter</span><span class="p">(),</span>
                            <span class="n">auto_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span>
            <span class="n">resizable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)-8.8s</span><span class="s2"> [</span><span class="si">%(name)s</span><span class="s2">:</span><span class="si">%(lineno)s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">traits_executor</span> <span class="o">=</span> <span class="n">TraitsExecutor</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">SquaringHelper</span><span class="p">(</span><span class="n">traits_executor</span><span class="o">=</span><span class="n">traits_executor</span><span class="p">)</span>
        <span class="n">view</span><span class="o">.</span><span class="n">configure_traits</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">traits_executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="prime-counting">
<h2>Prime counting<a class="headerlink" href="#prime-counting" title="Permalink to this headline">¶</a></h2>
<img alt="Screenshot of the prime counting GUI in action" src="../_images/prime_counting.png" />
<p>This <a class="reference download internal" download="" href="../_downloads/a48f3b142aa85b75baa38d28060e7ebe/prime_counting.py"><code class="xref download docutils literal notranslate"><span class="pre">example</span> <span class="pre">script</span></code></a> demonstrates the
<a class="reference internal" href="../api/traits_futures.background_progress.html#traits_futures.background_progress.ProgressFuture" title="traits_futures.background_progress.ProgressFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">ProgressFuture</span></code></a>, which reports progress information back to the
GUI as the background computation progresses.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (C) Copyright 2018-2021 Enthought, Inc., Austin, TX</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This software is provided without warranty under the terms of the BSD</span>
<span class="c1"># license included in LICENSE.txt and may be redistributed only under</span>
<span class="c1"># the conditions described in the aforementioned license. The license</span>
<span class="c1"># is also available online at http://www.enthought.com/licenses/BSD.txt</span>
<span class="c1">#</span>
<span class="c1"># Thanks for using Enthought open source!</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example showing progress reporting from a background computation, with a</span>
<span class="sd">modal progress dialog.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">pyface.qt</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>
<span class="kn">from</span> <span class="nn">pyface.ui.qt4.dialog</span> <span class="kn">import</span> <span class="n">Dialog</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Bool</span><span class="p">,</span>
    <span class="n">Button</span><span class="p">,</span>
    <span class="n">HasStrictTraits</span><span class="p">,</span>
    <span class="n">Instance</span><span class="p">,</span>
    <span class="n">Int</span><span class="p">,</span>
    <span class="n">observe</span><span class="p">,</span>
    <span class="n">Property</span><span class="p">,</span>
    <span class="n">Str</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CANCELLED</span><span class="p">,</span>
    <span class="n">COMPLETED</span><span class="p">,</span>
    <span class="n">ProgressFuture</span><span class="p">,</span>
    <span class="n">submit_progress</span><span class="p">,</span>
    <span class="n">TraitsExecutor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traitsui.api</span> <span class="kn">import</span> <span class="n">HGroup</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">UItem</span><span class="p">,</span> <span class="n">VGroup</span><span class="p">,</span> <span class="n">View</span>


<span class="k">class</span> <span class="nc">ProgressDialog</span><span class="p">(</span><span class="n">Dialog</span><span class="p">,</span> <span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dialog showing progress of the prime-counting operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: The future that we&#39;re listening to.</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">ProgressFuture</span><span class="p">)</span>

    <span class="c1">#: The message to display.</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">Str</span><span class="p">()</span>

    <span class="c1">#: The maximum number of steps.</span>
    <span class="n">maximum</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#: The current step.</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancel the running future when the cancel button is pressed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cancelled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cancelled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Cancelling</span><span class="se">\N{HORIZONTAL ELLIPSIS}</span><span class="s2">&quot;</span>

    <span class="c1"># Private traits ##########################################################</span>

    <span class="n">_cancel_button</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span>

    <span class="n">_message_control</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span>

    <span class="n">_progress_bar</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span>

    <span class="c1"># Private methods #########################################################</span>

    <span class="k">def</span> <span class="nf">_create_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_message</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">layout</span><span class="p">))</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_progress_bar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">layout</span><span class="p">))</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_cancel_button</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_cancel_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="n">buttons</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_button</span> <span class="o">=</span> <span class="n">buttons</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
            <span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">RejectRole</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_button</span><span class="o">.</span><span class="n">setDefault</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancel</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buttons</span>

    <span class="k">def</span> <span class="nf">_create_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_control</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">dialog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_control</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignTop</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_control</span>

    <span class="k">def</span> <span class="nf">_create_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QProgressBar</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_update_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">new</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message_control</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;maximum&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_update_progress_bar_maximum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">maximum</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">new</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">maximum</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_update_progress_bar_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">new</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:progress&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_report_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">progress_info</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">new</span>
        <span class="n">current_step</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">count_so_far</span> <span class="o">=</span> <span class="n">progress_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">max_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">current_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> chunks processed. </span><span class="si">{}</span><span class="s2"> primes found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">current_step</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">count_so_far</span>
        <span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:done&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_respond_to_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">isqrt</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the integer square root of a positive integer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether a nonnegative integer is prime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">isqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">count_primes_less_than</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count how many primes there are smaller than n.</span>

<span class="sd">    Uses a deliberately inefficient algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nchunks</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">//</span> <span class="n">chunk_size</span><span class="p">)</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">prime_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">chunk_index</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
        <span class="n">progress</span><span class="p">((</span><span class="n">chunk_index</span><span class="p">,</span> <span class="n">nchunks</span><span class="p">,</span> <span class="n">prime_count</span><span class="p">))</span>
        <span class="n">prime_count</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
    <span class="n">progress</span><span class="p">((</span><span class="n">nchunks</span><span class="p">,</span> <span class="n">nchunks</span><span class="p">,</span> <span class="n">prime_count</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">prime_count</span>


<span class="k">class</span> <span class="nc">PrimeCounter</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    UI to compute primes less than a given number.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: The Traits executor for the background jobs.</span>
    <span class="n">traits_executor</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">TraitsExecutor</span><span class="p">)</span>

    <span class="c1">#: Calculation future.</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">ProgressFuture</span><span class="p">)</span>

    <span class="c1">#: Number to count primes up to.</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span>

    <span class="c1">#: Chunk size to use for the calculation.</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1">#: Button to start the calculation.</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>

    <span class="c1">#: Bool indicating when the count should be enabled.</span>
    <span class="n">count_enabled</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Bool</span><span class="p">,</span> <span class="n">observe</span><span class="o">=</span><span class="s2">&quot;future.done&quot;</span><span class="p">)</span>

    <span class="c1">#: Result from the previous run.</span>
    <span class="n">result_message</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s2">&quot;No previous result&quot;</span><span class="p">)</span>

    <span class="c1">#: Limit used for most recent run.</span>
    <span class="n">_last_limit</span> <span class="o">=</span> <span class="n">Int</span><span class="p">()</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_count_primes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="o">=</span> <span class="n">submit_progress</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traits_executor</span><span class="p">,</span>
            <span class="n">count_primes_less_than</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_message</span> <span class="o">=</span> <span class="s2">&quot;Counting ...&quot;</span>

        <span class="n">dialog</span> <span class="o">=</span> <span class="n">ProgressDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Counting primes</span><span class="se">\N{HORIZONTAL ELLIPSIS}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">future</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_count_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">done</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:done&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_report_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">object</span>
        <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">COMPLETED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_message</span> <span class="o">=</span> <span class="s2">&quot;There are </span><span class="si">{}</span><span class="s2"> primes smaller than </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_limit</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">future</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CANCELLED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_message</span> <span class="o">=</span> <span class="s2">&quot;Run cancelled&quot;</span>

    <span class="k">def</span> <span class="nf">default_traits_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">View</span><span class="p">(</span>
            <span class="n">VGroup</span><span class="p">(</span>
                <span class="n">HGroup</span><span class="p">(</span>
                    <span class="n">Item</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Count primes up to&quot;</span><span class="p">),</span>
                    <span class="n">Item</span><span class="p">(</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">HGroup</span><span class="p">(</span>
                    <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">enabled_when</span><span class="o">=</span><span class="s2">&quot;count_enabled&quot;</span><span class="p">),</span>
                    <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;result_message&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;readonly&quot;</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">resizable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">traits_executor</span> <span class="o">=</span> <span class="n">TraitsExecutor</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">PrimeCounter</span><span class="p">(</span><span class="n">traits_executor</span><span class="o">=</span><span class="n">traits_executor</span><span class="p">)</span>
        <span class="n">view</span><span class="o">.</span><span class="n">configure_traits</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">traits_executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="approximating-pi">
<h2>Approximating Pi<a class="headerlink" href="#approximating-pi" title="Permalink to this headline">¶</a></h2>
<img alt="Screenshot of the π approximation GUI in action" src="../_images/pi_iterations.png" />
<p>The final <a class="reference download internal" download="" href="../_downloads/04d82d2836288784abacfe61222c3f74/pi_iterations.py"><code class="xref download docutils literal notranslate"><span class="pre">example</span></code></a> uses the Chaco 2d
plotting library and shows the use of the <a class="reference internal" href="../api/traits_futures.background_iteration.html#traits_futures.background_iteration.IterationFuture" title="traits_futures.background_iteration.IterationFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">IterationFuture</span></code></a>.
Successive approximations to π are computed and plotted, with the plot
updated live with each new value reported by the background task.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># (C) Copyright 2018-2021 Enthought, Inc., Austin, TX</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This software is provided without warranty under the terms of the BSD</span>
<span class="c1"># license included in LICENSE.txt and may be redistributed only under</span>
<span class="c1"># the conditions described in the aforementioned license. The license</span>
<span class="c1"># is also available online at http://www.enthought.com/licenses/BSD.txt</span>
<span class="c1">#</span>
<span class="c1"># Thanks for using Enthought open source!</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example showing a background iteration that produces successive</span>
<span class="sd">approximations to pi, with resulting values being used to update</span>
<span class="sd">a Chaco plot.</span>

<span class="sd">Note: this example requires NumPy and Chaco.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">chaco.api</span> <span class="kn">import</span> <span class="n">ArrayPlotData</span><span class="p">,</span> <span class="n">Plot</span>
<span class="kn">from</span> <span class="nn">chaco.overlays.coordinate_line_overlay</span> <span class="kn">import</span> <span class="n">CoordinateLineOverlay</span>
<span class="kn">from</span> <span class="nn">enable.component_editor</span> <span class="kn">import</span> <span class="n">ComponentEditor</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Bool</span><span class="p">,</span>
    <span class="n">Button</span><span class="p">,</span>
    <span class="n">Float</span><span class="p">,</span>
    <span class="n">HasStrictTraits</span><span class="p">,</span>
    <span class="n">Instance</span><span class="p">,</span>
    <span class="n">Int</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">observe</span><span class="p">,</span>
    <span class="n">Property</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IterationFuture</span><span class="p">,</span>
    <span class="n">submit_iteration</span><span class="p">,</span>
    <span class="n">TraitsExecutor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traitsui.api</span> <span class="kn">import</span> <span class="n">HGroup</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">UItem</span><span class="p">,</span> <span class="n">VGroup</span><span class="p">,</span> <span class="n">View</span>


<span class="k">def</span> <span class="nf">pi_iterations</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate successive approximations to pi via a Monte Carlo method.</span>

<span class="sd">    Infinite iterator producing successive approximations to pi, via the usual</span>
<span class="sd">    Monte-Carlo method: generate random points in a square, and count the</span>
<span class="sd">    proportion that lie in an inscribed circle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chunk_size : int</span>
<span class="sd">        The number of points to sample on each iteration.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    result : tuple (int, float, float)</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - the number of points generated</span>
<span class="sd">        - the approximation to pi</span>
<span class="sd">        - a two-sided error giving a ~95% confidence interval on the</span>
<span class="sd">          approximation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">ninside</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">nsamples</span> <span class="o">+=</span> <span class="n">chunk_size</span>
        <span class="n">ninside</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">samples</span> <span class="o">*</span> <span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">))</span>

        <span class="c1"># Compute approximation along with a two-sided error giving</span>
        <span class="c1"># a ~95% confidence interval on that approximation.</span>
        <span class="c1">#</span>
        <span class="c1"># We use a normal approximation interval. See wikipedia for details:</span>
        <span class="c1"># https://en.wikipedia.org/wiki/Binomial_proportion_confidence_interval</span>
        <span class="n">approximation</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">ninside</span> <span class="o">/</span> <span class="n">nsamples</span>
        <span class="n">noutside</span> <span class="o">=</span> <span class="n">nsamples</span> <span class="o">-</span> <span class="n">ninside</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mf">7.839856</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ninside</span> <span class="o">*</span> <span class="n">noutside</span> <span class="o">/</span> <span class="p">(</span><span class="n">nsamples</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">yield</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">approximation</span><span class="p">,</span> <span class="n">error</span>


<span class="k">class</span> <span class="nc">PiIterator</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View and plot of pi approximation running in the background.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: The Traits executor for the background jobs.</span>
    <span class="n">traits_executor</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">TraitsExecutor</span><span class="p">)</span>

    <span class="c1">#: Chunk size to use for the approximations.</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>

    <span class="c1">#: Calculation future.</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">IterationFuture</span><span class="p">)</span>

    <span class="c1">#: Results arriving from the future.</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Tuple</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">Float</span><span class="p">(),</span> <span class="n">Float</span><span class="p">()))</span>

    <span class="c1">#: Button to start the pi approximation.</span>
    <span class="n">approximate</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>

    <span class="c1">#: Is the approximate button enabled?</span>
    <span class="n">approximate_enabled</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span> <span class="n">observe</span><span class="o">=</span><span class="s2">&quot;future.state&quot;</span><span class="p">)</span>

    <span class="c1">#: Button to cancel the pi approximation.</span>
    <span class="n">cancel</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>

    <span class="c1">#: Is the cancel button enabled?</span>
    <span class="n">cancel_enabled</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span> <span class="n">observe</span><span class="o">=</span><span class="s2">&quot;future.state&quot;</span><span class="p">)</span>

    <span class="c1">#: Maximum number of points to show in the plot.</span>
    <span class="n">max_points</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1">#: Data for the plot.</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">ArrayPlotData</span><span class="p">,</span> <span class="p">())</span>

    <span class="c1">#: The plot.</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Plot</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;approximate&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_calculate_pi_approximately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="o">=</span> <span class="n">submit_iteration</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traits_executor</span><span class="p">,</span> <span class="n">pi_iterations</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span>
        <span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;cancel&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_cancel_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_reset_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:result_event&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_approximate_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">done</span>

    <span class="k">def</span> <span class="nf">_get_cancel_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">cancellable</span>

    <span class="k">def</span> <span class="nf">_update_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">recent_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_points</span> <span class="p">:]</span>  <span class="c1"># noqa: E203</span>
        <span class="c1"># We need the reshape for the case where the results list is empty.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recent_results</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">counts</span><span class="p">,</span> <span class="n">approx</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_data</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span>
            <span class="n">counts</span><span class="o">=</span><span class="n">counts</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span>
            <span class="n">approx</span><span class="o">=</span><span class="n">approx</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="n">approx</span> <span class="o">+</span> <span class="n">errors</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">approx</span> <span class="o">-</span> <span class="n">errors</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_plot_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot_data</span><span class="p">()</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;approx&quot;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">x_axis</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Counts (millions of points)&quot;</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">y_axis</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Approximation&quot;</span>

        <span class="c1"># Add dashed horizontal line at pi.</span>
        <span class="n">pi_line</span> <span class="o">=</span> <span class="n">CoordinateLineOverlay</span><span class="p">(</span>
            <span class="n">component</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">value_data</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="n">line_style</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">underlays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi_line</span><span class="p">)</span>

        <span class="c1"># Allow extra room for the y-axis label.</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">padding_left</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="n">plot</span>

    <span class="k">def</span> <span class="nf">default_traits_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">View</span><span class="p">(</span>
            <span class="n">HGroup</span><span class="p">(</span>
                <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;plot&quot;</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="n">ComponentEditor</span><span class="p">()),</span>
                <span class="n">VGroup</span><span class="p">(</span>
                    <span class="n">Item</span><span class="p">(</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">),</span>
                    <span class="n">Item</span><span class="p">(</span><span class="s2">&quot;max_points&quot;</span><span class="p">),</span>
                    <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;approximate&quot;</span><span class="p">,</span> <span class="n">enabled_when</span><span class="o">=</span><span class="s2">&quot;approximate_enabled&quot;</span><span class="p">),</span>
                    <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;cancel&quot;</span><span class="p">,</span> <span class="n">enabled_when</span><span class="o">=</span><span class="s2">&quot;cancel_enabled&quot;</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">resizable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">traits_executor</span> <span class="o">=</span> <span class="n">TraitsExecutor</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">PiIterator</span><span class="p">(</span><span class="n">traits_executor</span><span class="o">=</span><span class="n">traits_executor</span><span class="p">)</span>
        <span class="n">view</span><span class="o">.</span><span class="n">configure_traits</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">traits_executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/img/e-logo.png" alt="Logo">
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Complete examples</a><ul>
<li><a class="reference internal" href="#slow-squares">Slow squares</a></li>
<li><a class="reference internal" href="#prime-counting">Prime counting</a></li>
<li><a class="reference internal" href="#approximating-pi">Approximating Pi</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="advanced.html"
                        title="previous chapter">Advanced topics</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../api/traits_futures.html"
                        title="next chapter">traits_futures package</a></p>
  <h3>This Page</h3>
  <div>
    <a href="../_sources/guide/examples.rst.txt"
       rel="nofollow">Show Source</a>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2018-2021 Enthought, Inc., Austin, TX
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.1.2.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>