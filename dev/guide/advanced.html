<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Advanced topics &mdash; Traits Futures 0.3.0.dev0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    <link rel="stylesheet" href="../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" >
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.3.0.dev0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        LINK_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../_static/js/wrap_on_dot.js"></script>
    <link rel="shortcut icon" href="../_static/img/favicon.ico">
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="Traits Futures 0.3.0.dev0 documentation" href="../index.html" >
    <link rel="next" title="Complete examples" href="examples.html" >
    <link rel="prev" title="Testing Traits Futures code" href="testing.html" > 
  </head>
  <body>
  <div class="container">
    <div class="header">
    </div>
  </div>

    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../index.html">Traits Futures 0.3.0.dev0 documentation</a></li>
	 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
      <li class="active">
        <a href="examples.html" title="Complete examples"
           accesskey="N">next</a>
      </li>
      <li class="active">
        <a href="testing.html" title="Testing Traits Futures code"
           accesskey="P">previous</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body" role="main">
            
  <section id="advanced-topics">
<h1>Advanced topics<a class="headerlink" href="#advanced-topics" title="Permalink to this headline">¶</a></h1>
<section id="creating-your-own-background-task-type">
<h2>Creating your own background task type<a class="headerlink" href="#creating-your-own-background-task-type" title="Permalink to this headline">¶</a></h2>
<p>Traits Futures comes with three basic background task types: background calls,
background iterations and background progress calls, created via the
<a class="reference internal" href="../api/traits_futures.background_call.html#traits_futures.background_call.submit_call" title="traits_futures.background_call.submit_call"><code class="xref py py-func docutils literal notranslate"><span class="pre">submit_call</span></code></a>, <a class="reference internal" href="../api/traits_futures.background_iteration.html#traits_futures.background_iteration.submit_iteration" title="traits_futures.background_iteration.submit_iteration"><code class="xref py py-func docutils literal notranslate"><span class="pre">submit_iteration</span></code></a> and <a class="reference internal" href="../api/traits_futures.background_progress.html#traits_futures.background_progress.submit_progress" title="traits_futures.background_progress.submit_progress"><code class="xref py py-func docutils literal notranslate"><span class="pre">submit_progress</span></code></a> functions,
respectively. In each case, communication from the background task to the
corresponding foreground <a class="reference internal" href="../api/traits_futures.i_future.html#traits_futures.i_future.IFuture" title="traits_futures.i_future.IFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">IFuture</span></code></a> instance is implemented by sending
custom task-type-specific messages, with the type of message identified by
a suitable string. For example, the background progress task sends messages
of type <code class="docutils literal notranslate"><span class="pre">&quot;progress&quot;</span></code> to report progress, while the background iteration task
sends messages of type <code class="docutils literal notranslate"><span class="pre">&quot;generated&quot;</span></code>.</p>
<p>If none of the standard task types meets your needs, it’s possible to write
your own background task type, that sends whatever messages you like. This
section describes how to do this in detail.</p>
<p>To create your own task type, you’ll need three ingredients:</p>
<ul class="simple">
<li><p>A factory for the background callable.</p></li>
<li><p>A suitable future type, implementing the <a class="reference internal" href="../api/traits_futures.i_future.html#traits_futures.i_future.IFuture" title="traits_futures.i_future.IFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">IFuture</span></code></a> interface.</p></li>
<li><p>A <em>task specification</em> class, implementing the <a class="reference internal" href="../api/traits_futures.i_task_specification.html#traits_futures.i_task_specification.ITaskSpecification" title="traits_futures.i_task_specification.ITaskSpecification"><code class="xref py py-class docutils literal notranslate"><span class="pre">ITaskSpecification</span></code></a>
interface. The <a class="reference internal" href="../api/traits_futures.traits_executor.html#traits_futures.traits_executor.TraitsExecutor.submit" title="traits_futures.traits_executor.TraitsExecutor.submit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">submit</span></code></a> method of the TraitsExecutor expects an instance of
<a class="reference internal" href="../api/traits_futures.i_task_specification.html#traits_futures.i_task_specification.ITaskSpecification" title="traits_futures.i_task_specification.ITaskSpecification"><code class="xref py py-class docutils literal notranslate"><span class="pre">ITaskSpecification</span></code></a>, and interrogates that instance to get the background
callable and the corresponding foreground future.</p></li>
</ul>
<p>Below we give a worked example that demonstrates how to create each of these
ingredients for a simple case.</p>
</section>
<section id="worked-example-fizz-buzz">
<h2>Worked example: Fizz buzz!<a class="headerlink" href="#worked-example-fizz-buzz" title="Permalink to this headline">¶</a></h2>
<p>In this section we’ll create an example new background task type, based on the
well-known <a class="reference external" href="https://en.wikipedia.org/wiki/Fizz_buzz">Fizz buzz</a> game. We’ll create a background task that
counts slowly from 1, sending three different types of messages to the
foreground: it sends “Fizz” messages on multiples of 3, “Buzz” messages on
multiples of 5, and “Fizz Buzz” messages on multiples of 15. Each message
is accompanied by the corresponding number.</p>
<section id="message-types">
<h3>Message types<a class="headerlink" href="#message-types" title="Permalink to this headline">¶</a></h3>
<p>In general, the message sent from the background task to the future can be any
Python object, and the future can interpret the sent object in any way that it
likes. However, the <a class="reference internal" href="../api/traits_futures.base_future.html#traits_futures.base_future.BaseFuture" title="traits_futures.base_future.BaseFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseFuture</span></code></a> base class that we’ll use below provides a
default dispatcher for messages, and that dispatcher expects those messages to
have the form <code class="docutils literal notranslate"><span class="pre">(message_type,</span> <span class="pre">message_args)</span></code>. Here the message type should be
a string that’s valid as a Python identifier, while the message argument can be
any Python object (though it should usually be pickleable and immutable).</p>
<p>We first define named constants representing our three message types. This
isn’t strictly necessary, but it makes the code cleaner.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FIZZ</span> <span class="o">=</span> <span class="s2">&quot;fizz&quot;</span>
<span class="n">BUZZ</span> <span class="o">=</span> <span class="s2">&quot;buzz&quot;</span>
<span class="n">FIZZ_BUZZ</span> <span class="o">=</span> <span class="s2">&quot;fizz_buzz&quot;</span>
</pre></div>
</div>
</section>
<section id="the-background-callable">
<h3>The background callable<a class="headerlink" href="#the-background-callable" title="Permalink to this headline">¶</a></h3>
<p>Next, we define the callable that will be run in the background. This callable
must accept two arguments (which will be passed by position): <code class="docutils literal notranslate"><span class="pre">send</span></code> and
<code class="docutils literal notranslate"><span class="pre">cancelled</span></code>. The <code class="docutils literal notranslate"><span class="pre">send</span></code> object is a callable which will be used to send
messages to the foreground. The <code class="docutils literal notranslate"><span class="pre">cancelled</span></code> object is a zero-argument
callable which can be used to check for cancellation requests. Here’s the
<code class="docutils literal notranslate"><span class="pre">fizz_buzz</span></code> callable.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">fizz_buzz</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="n">cancelled</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count slowly from 1, sending FIZZ / BUZZ messages to the foreground.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    send : callable(object) -&gt; None</span>
<span class="sd">        Callable accepting the message to be sent, and returning nothing. The</span>
<span class="sd">        message argument should be pickleable, and preferably immutable (or at</span>
<span class="sd">        least, not intended to be mutated).</span>
<span class="sd">    cancelled : callable</span>
<span class="sd">        Callable accepting no arguments and returning a boolean result. It</span>
<span class="sd">        returns ``True`` if cancellation has been requested, and ``False``</span>
<span class="sd">        otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">cancelled</span><span class="p">():</span>

        <span class="n">n_is_multiple_of_3</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">n_is_multiple_of_5</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">n_is_multiple_of_3</span> <span class="ow">and</span> <span class="n">n_is_multiple_of_5</span><span class="p">:</span>
            <span class="n">send</span><span class="p">((</span><span class="n">FIZZ_BUZZ</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">n_is_multiple_of_3</span><span class="p">:</span>
            <span class="n">send</span><span class="p">((</span><span class="n">FIZZ</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">n_is_multiple_of_5</span><span class="p">:</span>
            <span class="n">send</span><span class="p">((</span><span class="n">BUZZ</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>In this example, we don’t return anything from the <code class="docutils literal notranslate"><span class="pre">fizz_buzz</span></code> function, but
in general any object returned by the background callable will be made
available under the <a class="reference internal" href="../api/traits_futures.i_future.html#traits_futures.i_future.IFuture.result" title="traits_futures.i_future.IFuture.result"><code class="xref py py-attr docutils literal notranslate"><span class="pre">result</span></code></a> property of the corresponding future. Similarly,
any exception raised during execution will be made available under the
<a class="reference internal" href="../api/traits_futures.i_future.html#traits_futures.i_future.IFuture.exception" title="traits_futures.i_future.IFuture.exception"><code class="xref py py-attr docutils literal notranslate"><span class="pre">exception</span></code></a> property of the corresponding future.</p>
</section>
<section id="the-foreground-future">
<h3>The foreground Future<a class="headerlink" href="#the-foreground-future" title="Permalink to this headline">¶</a></h3>
<p>Now we define a dedicated future class <code class="docutils literal notranslate"><span class="pre">FizzBuzzFuture</span></code> for this background
task type. The most convenient way to do this is to inherit from the
<a class="reference internal" href="../api/traits_futures.base_future.html#traits_futures.base_future.BaseFuture" title="traits_futures.base_future.BaseFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseFuture</span></code></a> class, which is a <a class="reference external" href="https://docs.enthought.com/traits/traits_api_reference/has_traits.html#traits.has_traits.HasStrictTraits" title="(in traits v6.2)"><code class="xref py py-class docutils literal notranslate"><span class="pre">HasStrictTraits</span></code></a> subclass that provides the
<a class="reference internal" href="../api/traits_futures.i_future.html#traits_futures.i_future.IFuture" title="traits_futures.i_future.IFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">IFuture</span></code></a> interface. Messages coming into the <a class="reference internal" href="../api/traits_futures.base_future.html#traits_futures.base_future.BaseFuture" title="traits_futures.base_future.BaseFuture"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseFuture</span></code></a> instance from the
background task are processed by the <code class="xref py py-meth docutils literal notranslate"><span class="pre">_task_sent</span></code> method. The default
implementation of this method expects incoming messages to have the
form <code class="docutils literal notranslate"><span class="pre">(message_type,</span> <span class="pre">message_arg)</span></code>, and does a couple of things:</p>
<ul class="simple">
<li><p>it dispatches the argument of each message to a method named
<code class="docutils literal notranslate"><span class="pre">_process_&lt;message_type&gt;</span></code>.</p></li>
<li><p>it suppresses any messages that arrive after cancellation has been requested</p></li>
</ul>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">_task_sent</span></code> method can be safely overridden by subclasses if messages
do not have the form <code class="docutils literal notranslate"><span class="pre">(message_type,</span> <span class="pre">message_arg)</span></code>, or if some
other dispatch mechanism is wanted. For this example, we use the default
dispatch mechanism, so all we need to do is to define methods
<code class="docutils literal notranslate"><span class="pre">_process_fizz</span></code>, <code class="docutils literal notranslate"><span class="pre">_process_buzz</span></code> and <code class="docutils literal notranslate"><span class="pre">_process_fizz_buzz</span></code> to handle
messages of types <code class="docutils literal notranslate"><span class="pre">FIZZ</span></code>, <code class="docutils literal notranslate"><span class="pre">BUZZ</span></code> and <code class="docutils literal notranslate"><span class="pre">FIZZ_BUZZ</span></code> respectively. We choose
to process each message by firing a corresponding event on the future.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Int</span>
<span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="n">BaseFuture</span>


<span class="k">class</span> <span class="nc">FizzBuzzFuture</span><span class="p">(</span><span class="n">BaseFuture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object representing the front-end handle to a running fizz_buzz call.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Event fired whenever we get a FIZZ message. The payload is the</span>
    <span class="c1">#: corresponding integer.</span>
    <span class="n">fizz</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>

    <span class="c1">#: Event fired whenever we get a BUZZ message. The payload is the</span>
    <span class="c1">#: corresponding integer.</span>
    <span class="n">buzz</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>

    <span class="c1">#: Event fired whenever a FIZZ_BUZZ arrives from the background.</span>
    <span class="c1">#: The payload is the corresponding integer.</span>
    <span class="n">fizz_buzz</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>

    <span class="c1"># Private methods #########################################################</span>

    <span class="k">def</span> <span class="nf">_process_fizz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fizz</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_process_buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buzz</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_process_fizz_buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fizz_buzz</span> <span class="o">=</span> <span class="n">n</span>
</pre></div>
</div>
</section>
<section id="putting-it-all-together-the-task-specification">
<h3>Putting it all together: the task specification<a class="headerlink" href="#putting-it-all-together-the-task-specification" title="Permalink to this headline">¶</a></h3>
<p>The last piece we need is a task specification, which is the object that can be
submitted to the <a class="reference internal" href="../api/traits_futures.traits_executor.html#traits_futures.traits_executor.TraitsExecutor" title="traits_futures.traits_executor.TraitsExecutor"><code class="xref py py-class docutils literal notranslate"><span class="pre">TraitsExecutor</span></code></a>. This object needs to have two attributes:
<code class="docutils literal notranslate"><span class="pre">future</span></code> and <code class="docutils literal notranslate"><span class="pre">background_task</span></code>. Given an instance <code class="docutils literal notranslate"><span class="pre">task</span></code> of a task
specification, the <a class="reference internal" href="../api/traits_futures.traits_executor.html#traits_futures.traits_executor.TraitsExecutor" title="traits_futures.traits_executor.TraitsExecutor"><code class="xref py py-class docutils literal notranslate"><span class="pre">TraitsExecutor</span></code></a> calls <code class="docutils literal notranslate"><span class="pre">task.future()</span></code>
to create the future, and <code class="docutils literal notranslate"><span class="pre">task.background_task()</span></code> to create the background
callable. For the background task, we want to return (but not call!) the
<code class="docutils literal notranslate"><span class="pre">fizz_buzz</span></code> function that we defined above. For the future, we create and
return a new <code class="docutils literal notranslate"><span class="pre">FizzBuzzFuture</span></code> instance. So our task specification
looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="n">ITaskSpecification</span>


<span class="nd">@ITaskSpecification</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span> <span class="nc">BackgroundFizzBuzz</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task specification for Fizz Buzz background tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">future</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a Future for the background task.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FizzBuzzFuture</span>
<span class="sd">            Future object that can be used to monitor the status of the</span>
<span class="sd">            background task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FizzBuzzFuture</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">background_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a background callable for this task specification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        collections.abc.Callable</span>
<span class="sd">            Callable accepting arguments ``send`` and ``cancelled``. The</span>
<span class="sd">            callable can use ``send`` to send messages and ``cancelled`` to</span>
<span class="sd">            check whether cancellation has been requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">fizz_buzz</span>
</pre></div>
</div>
</section>
<section id="submitting-the-new-task">
<h3>Submitting the new task<a class="headerlink" href="#submitting-the-new-task" title="Permalink to this headline">¶</a></h3>
<p>With all of the above in place, a Fizz buzz background task can be submitted to
a <a class="reference internal" href="../api/traits_futures.traits_executor.html#traits_futures.traits_executor.TraitsExecutor" title="traits_futures.traits_executor.TraitsExecutor"><code class="xref py py-class docutils literal notranslate"><span class="pre">TraitsExecutor</span></code></a> <code class="docutils literal notranslate"><span class="pre">executor</span></code> by passing an instance of
<code class="docutils literal notranslate"><span class="pre">BackgroundFizzBuzz</span></code> to <code class="docutils literal notranslate"><span class="pre">executor.submit</span></code>. For convenience, we can
encapsulate that operation in a function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">submit_fizz_buzz</span><span class="p">(</span><span class="n">executor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to submit a Fizz buzz task to an executor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    executor : TraitsExecutor</span>
<span class="sd">        The executor to submit the task to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    future : FizzBuzzFuture</span>
<span class="sd">        The future for the background task, allowing monitoring and</span>
<span class="sd">        cancellation of the background task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">BackgroundFizzBuzz</span><span class="p">()</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">future</span>
</pre></div>
</div>
</section>
<section id="an-example-gui">
<h3>An example GUI<a class="headerlink" href="#an-example-gui" title="Permalink to this headline">¶</a></h3>
<p>Here’s the <a class="reference download internal" download="" href="../_downloads/c3ba6c80aacc0c4457e8c865f82049cf/fizz_buzz_task.py"><code class="xref download docutils literal notranslate"><span class="pre">complete</span> <span class="pre">script</span></code></a> obtained
from putting together the above snippets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example of a user-created background task type.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># This Python file provides supporting code for the &quot;advanced&quot; section of the</span>
<span class="c1"># user guide. Because we&#39;re using pieces of the file for documentation</span>
<span class="c1"># snippets, the overall structure of this file is a little odd, and doesn&#39;t</span>
<span class="c1"># follow standard style guidelines (for example, placing imports at the top</span>
<span class="c1"># of the file). The various &#39;# -- start&#39; and &#39;# -- end&#39; markers are there</span>
<span class="c1"># to allow the documentation build to extract the appropriate pieces.</span>


<span class="c1"># -- start message types</span>
<span class="n">FIZZ</span> <span class="o">=</span> <span class="s2">&quot;fizz&quot;</span>
<span class="n">BUZZ</span> <span class="o">=</span> <span class="s2">&quot;buzz&quot;</span>
<span class="n">FIZZ_BUZZ</span> <span class="o">=</span> <span class="s2">&quot;fizz_buzz&quot;</span>
<span class="c1"># -- end message types</span>


<span class="c1"># -- start fizz_buzz --</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">fizz_buzz</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="n">cancelled</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count slowly from 1, sending FIZZ / BUZZ messages to the foreground.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    send : callable(object) -&gt; None</span>
<span class="sd">        Callable accepting the message to be sent, and returning nothing. The</span>
<span class="sd">        message argument should be pickleable, and preferably immutable (or at</span>
<span class="sd">        least, not intended to be mutated).</span>
<span class="sd">    cancelled : callable</span>
<span class="sd">        Callable accepting no arguments and returning a boolean result. It</span>
<span class="sd">        returns ``True`` if cancellation has been requested, and ``False``</span>
<span class="sd">        otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">cancelled</span><span class="p">():</span>

        <span class="n">n_is_multiple_of_3</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">n_is_multiple_of_5</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">n_is_multiple_of_3</span> <span class="ow">and</span> <span class="n">n_is_multiple_of_5</span><span class="p">:</span>
            <span class="n">send</span><span class="p">((</span><span class="n">FIZZ_BUZZ</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">n_is_multiple_of_3</span><span class="p">:</span>
            <span class="n">send</span><span class="p">((</span><span class="n">FIZZ</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">n_is_multiple_of_5</span><span class="p">:</span>
            <span class="n">send</span><span class="p">((</span><span class="n">BUZZ</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1"># -- end fizz_buzz --</span>


<span class="c1"># -- start FizzBuzzFuture --</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Int</span>
<span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="n">BaseFuture</span>


<span class="k">class</span> <span class="nc">FizzBuzzFuture</span><span class="p">(</span><span class="n">BaseFuture</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object representing the front-end handle to a running fizz_buzz call.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Event fired whenever we get a FIZZ message. The payload is the</span>
    <span class="c1">#: corresponding integer.</span>
    <span class="n">fizz</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>

    <span class="c1">#: Event fired whenever we get a BUZZ message. The payload is the</span>
    <span class="c1">#: corresponding integer.</span>
    <span class="n">buzz</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>

    <span class="c1">#: Event fired whenever a FIZZ_BUZZ arrives from the background.</span>
    <span class="c1">#: The payload is the corresponding integer.</span>
    <span class="n">fizz_buzz</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>

    <span class="c1"># Private methods #########################################################</span>

    <span class="k">def</span> <span class="nf">_process_fizz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fizz</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_process_buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buzz</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_process_fizz_buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fizz_buzz</span> <span class="o">=</span> <span class="n">n</span>
<span class="c1"># -- end FizzBuzzFuture --</span>


<span class="c1"># -- start BackgroundFizzBuzz --</span>
<span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="n">ITaskSpecification</span>


<span class="nd">@ITaskSpecification</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span> <span class="nc">BackgroundFizzBuzz</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task specification for Fizz Buzz background tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">future</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a Future for the background task.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FizzBuzzFuture</span>
<span class="sd">            Future object that can be used to monitor the status of the</span>
<span class="sd">            background task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FizzBuzzFuture</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">background_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a background callable for this task specification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        collections.abc.Callable</span>
<span class="sd">            Callable accepting arguments ``send`` and ``cancelled``. The</span>
<span class="sd">            callable can use ``send`` to send messages and ``cancelled`` to</span>
<span class="sd">            check whether cancellation has been requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">fizz_buzz</span>
<span class="c1"># -- end BackgroundFizzBuzz</span>


<span class="c1"># -- start submit_fizz_buzz</span>
<span class="k">def</span> <span class="nf">submit_fizz_buzz</span><span class="p">(</span><span class="n">executor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to submit a Fizz buzz task to an executor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    executor : TraitsExecutor</span>
<span class="sd">        The executor to submit the task to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    future : FizzBuzzFuture</span>
<span class="sd">        The future for the background task, allowing monitoring and</span>
<span class="sd">        cancellation of the background task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">BackgroundFizzBuzz</span><span class="p">()</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">future</span>
<span class="c1"># -- end submit_fizz_buzz</span>
</pre></div>
</div>
<p>And here’s an <a class="reference download internal" download="" href="../_downloads/7ccb602d9eec5511385b374338d26b47/fizz_buzz_ui.py"><code class="xref download docutils literal notranslate"><span class="pre">example</span> <span class="pre">GUI</span></code></a> that makes use
of the new background task type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example of a custom background job type.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Bool</span><span class="p">,</span>
    <span class="n">Button</span><span class="p">,</span>
    <span class="n">HasStrictTraits</span><span class="p">,</span>
    <span class="n">Instance</span><span class="p">,</span>
    <span class="n">observe</span><span class="p">,</span>
    <span class="n">Property</span><span class="p">,</span>
    <span class="n">Str</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traits_futures.api</span> <span class="kn">import</span> <span class="n">TraitsExecutor</span>
<span class="kn">from</span> <span class="nn">traitsui.api</span> <span class="kn">import</span> <span class="n">HGroup</span><span class="p">,</span> <span class="n">UItem</span><span class="p">,</span> <span class="n">View</span>

<span class="kn">from</span> <span class="nn">fizz_buzz_task</span> <span class="kn">import</span> <span class="n">FizzBuzzFuture</span><span class="p">,</span> <span class="n">submit_fizz_buzz</span>


<span class="k">class</span> <span class="nc">FizzBuzzUI</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="c1">#: The executor to submit tasks to.</span>
    <span class="n">executor</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">TraitsExecutor</span><span class="p">,</span> <span class="p">())</span>

    <span class="c1">#: The future object returned on task submission.</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">FizzBuzzFuture</span><span class="p">)</span>

    <span class="c1">#: Status message showing current state or the last-received result.</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s2">&quot;Ready&quot;</span><span class="p">)</span>

    <span class="c1">#: Button to calculate, plus its enabled state.</span>
    <span class="n">calculate</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>
    <span class="n">can_calculate</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span> <span class="n">observe</span><span class="o">=</span><span class="s2">&quot;future&quot;</span><span class="p">)</span>

    <span class="c1">#: Button to cancel, plus its enabled state.</span>
    <span class="n">cancel</span> <span class="o">=</span> <span class="n">Button</span><span class="p">()</span>
    <span class="n">can_cancel</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span> <span class="n">observe</span><span class="o">=</span><span class="s2">&quot;future.cancellable&quot;</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;calculate&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_submit_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Running&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="o">=</span> <span class="n">submit_fizz_buzz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;cancel&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_cancel_running_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Cancelling&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:fizz&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_report_fizz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Fizz </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:buzz&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_report_buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Buzz </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:fizz_buzz&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_report_fizz_buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;FIZZ BUZZ! </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;future:done&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_reset_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Ready&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_can_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_can_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">cancellable</span>

    <span class="n">traits_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span>
        <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;readonly&quot;</span><span class="p">),</span>
        <span class="n">HGroup</span><span class="p">(</span>
            <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;calculate&quot;</span><span class="p">,</span> <span class="n">enabled_when</span><span class="o">=</span><span class="s2">&quot;can_calculate&quot;</span><span class="p">),</span>
            <span class="n">UItem</span><span class="p">(</span><span class="s2">&quot;cancel&quot;</span><span class="p">,</span> <span class="n">enabled_when</span><span class="o">=</span><span class="s2">&quot;can_cancel&quot;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">resizable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">FizzBuzzUI</span><span class="p">()</span><span class="o">.</span><span class="n">configure_traits</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>


          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/img/e-logo.png" alt="Logo">
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Advanced topics</a><ul>
<li><a class="reference internal" href="#creating-your-own-background-task-type">Creating your own background task type</a></li>
<li><a class="reference internal" href="#worked-example-fizz-buzz">Worked example: Fizz buzz!</a><ul>
<li><a class="reference internal" href="#message-types">Message types</a></li>
<li><a class="reference internal" href="#the-background-callable">The background callable</a></li>
<li><a class="reference internal" href="#the-foreground-future">The foreground Future</a></li>
<li><a class="reference internal" href="#putting-it-all-together-the-task-specification">Putting it all together: the task specification</a></li>
<li><a class="reference internal" href="#submitting-the-new-task">Submitting the new task</a></li>
<li><a class="reference internal" href="#an-example-gui">An example GUI</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="testing.html"
                        title="previous chapter">Testing Traits Futures code</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="examples.html"
                        title="next chapter">Complete examples</a></p>
  <h3>This Page</h3>
  <div>
    <a href="../_sources/guide/advanced.rst.txt"
       rel="nofollow">Show Source</a>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2018-2021 Enthought, Inc., Austin, TX
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.0.3.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>