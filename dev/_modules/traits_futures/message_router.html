<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>traits_futures.message_router &mdash; Traits Futures 0.3.0.dev0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" >
    <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" >
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.0.dev0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        LINK_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../../_static/js/wrap_on_dot.js"></script>
    <link rel="shortcut icon" href="../../_static/img/favicon.ico">
    <link rel="index" title="Index" href="../../genindex.html" >
    <link rel="search" title="Search" href="../../search.html" >
    <link rel="top" title="Traits Futures 0.3.0.dev0 documentation" href="../../index.html" >
    <link rel="up" title="Module code" href="../index.html" > 
  </head>
  <body>
  <div class="container">
    <div class="header">
    </div>
  </div>

    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../../index.html">Traits Futures 0.3.0.dev0 documentation</a></li>
	
          <li class="active"><a href="../index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body" role="main">
            
  <h1>Source code for traits_futures.message_router</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) Copyright 2018-2020 Enthought, Inc., Austin, TX</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This software is provided without warranty under the terms of the BSD</span>
<span class="c1"># license included in LICENSE.txt and may be redistributed only under</span>
<span class="c1"># the conditions described in the aforementioned license. The license</span>
<span class="c1"># is also available online at http://www.enthought.com/licenses/BSD.txt</span>
<span class="c1">#</span>
<span class="c1"># Thanks for using Enthought open source!</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Message routing from background threads to the GUI event loop.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">queue</span>

<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">HasStrictTraits</span><span class="p">,</span> <span class="n">Instance</span><span class="p">,</span> <span class="n">Int</span>

<span class="kn">from</span> <span class="nn">traits_futures.message_receiver</span> <span class="kn">import</span> <span class="n">MessageReceiver</span>
<span class="kn">from</span> <span class="nn">traits_futures.multithreading_sender</span> <span class="kn">import</span> <span class="n">MultithreadingSender</span>
<span class="kn">from</span> <span class="nn">traits_futures.toolkit_support</span> <span class="kn">import</span> <span class="n">toolkit</span>

<span class="n">Pingee</span> <span class="o">=</span> <span class="n">toolkit</span><span class="p">(</span><span class="s2">&quot;pinger:Pingee&quot;</span><span class="p">)</span>
<span class="n">Pinger</span> <span class="o">=</span> <span class="n">toolkit</span><span class="p">(</span><span class="s2">&quot;pinger:Pinger&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="MessageRouter"><a class="viewcode-back" href="../../api/traits_futures.message_router.html#traits_futures.message_router.MessageRouter">[docs]</a><span class="k">class</span> <span class="nc">MessageRouter</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Router for messages from a background thread.</span>

<span class="sd">    Requires the event loop to be running in order for messages to arrive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Event fired when a receiver is dropped from the routing table.</span>
    <span class="n">receiver_done</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">Instance</span><span class="p">(</span><span class="n">MessageReceiver</span><span class="p">))</span>

<div class="viewcode-block" id="MessageRouter.pipe"><a class="viewcode-back" href="../../api/traits_futures.message_router.html#traits_futures.message_router.MessageRouter.pipe">[docs]</a>    <span class="k">def</span> <span class="nf">pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a (sender, receiver) pair for sending messages.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sender : MultithreadingSender</span>
<span class="sd">            Object to be passed to the background task to send messages.</span>
<span class="sd">        receiver : MessageReceiver</span>
<span class="sd">            Object to be kept in the foreground which reacts to messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_ids</span><span class="p">)</span>
        <span class="n">pinger</span> <span class="o">=</span> <span class="n">Pinger</span><span class="p">(</span><span class="n">pingee</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pingee</span><span class="p">)</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">MultithreadingSender</span><span class="p">(</span>
            <span class="n">connection_id</span><span class="o">=</span><span class="n">connection_id</span><span class="p">,</span>
            <span class="n">pinger</span><span class="o">=</span><span class="n">pinger</span><span class="p">,</span>
            <span class="n">message_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_queue</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">receiver</span> <span class="o">=</span> <span class="n">MessageReceiver</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receivers</span><span class="p">[</span><span class="n">connection_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">receiver</span>
        <span class="k">return</span> <span class="n">sender</span><span class="p">,</span> <span class="n">receiver</span></div>

<div class="viewcode-block" id="MessageRouter.close_pipe"><a class="viewcode-back" href="../../api/traits_futures.message_router.html#traits_futures.message_router.MessageRouter.close_pipe">[docs]</a>    <span class="k">def</span> <span class="nf">close_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">receiver</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close an unused pipe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection_id</span> <span class="o">=</span> <span class="n">sender</span><span class="o">.</span><span class="n">connection_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receivers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">connection_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="MessageRouter.connect"><a class="viewcode-back" href="../../api/traits_futures.message_router.html#traits_futures.message_router.MessageRouter.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare router for routing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="MessageRouter.disconnect"><a class="viewcode-back" href="../../api/traits_futures.message_router.html#traits_futures.message_router.MessageRouter.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo any connections made by the ``connect`` call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># Private traits ##########################################################</span>

    <span class="c1">#: Internal queue for messages from all senders.</span>
    <span class="n">_message_queue</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span>

    <span class="c1">#: Source of new connection ids.</span>
    <span class="n">_connection_ids</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterator</span><span class="p">)</span>

    <span class="c1">#: Receivers, keyed by connection_id.</span>
    <span class="n">_receivers</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">Any</span><span class="p">())</span>

    <span class="c1">#: Receiver for the &quot;message_sent&quot; signal.</span>
    <span class="n">_pingee</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Pingee</span><span class="p">)</span>

    <span class="c1"># Private methods #########################################################</span>

    <span class="k">def</span> <span class="nf">_route_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wrapped_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wrapped_message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">connection_id</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">wrapped_message</span>
            <span class="n">receiver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receivers</span><span class="p">[</span><span class="n">connection_id</span><span class="p">]</span>
            <span class="n">receiver</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">wrapped_message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">connection_id</span> <span class="o">=</span> <span class="n">wrapped_message</span>
            <span class="n">receiver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receivers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">connection_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">receiver_done</span> <span class="o">=</span> <span class="n">receiver</span>

    <span class="k">def</span> <span class="nf">__message_queue_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__connection_ids_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__pingee_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pingee</span><span class="p">(</span><span class="n">on_ping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_route_message</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/img/e-logo.png" alt="Logo">
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright (C) Copyright 2018-2020 Enthought, Inc., Austin, TX
All rights reserved.

This software is provided without warranty under the terms of the BSD
license included in LICENSE.txt and may be redistributed only under
the conditions described in the aforementioned license. The license
is also available online at http://www.enthought.com/licenses/BSD.txt

Thanks for using Enthought open source!

      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 3.3.1.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>