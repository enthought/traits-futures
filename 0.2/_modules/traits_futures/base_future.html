<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>traits_futures.base_future &mdash; Traits Futures 0.2.0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" >
    <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" >
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        LINK_SUFFIX: '',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../../_static/js/wrap_on_dot.js"></script>
    <link rel="shortcut icon" href="../../_static/img/favicon.ico">
    <link rel="index" title="Index" href="../../genindex.html" >
    <link rel="search" title="Search" href="../../search.html" >
    <link rel="top" title="Traits Futures 0.2.0 documentation" href="../../index.html" >
    <link rel="up" title="Module code" href="../index.html" > 
  </head>
  <body>
  <div class="container">
    <div class="header">
    </div>
  </div>

    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../../index.html">Traits Futures 0.2.0 documentation</a></li>
	
          <li class="active"><a href="../index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body" role="main">
            
  <h1>Source code for traits_futures.base_future</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) Copyright 2018-2020 Enthought, Inc., Austin, TX</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This software is provided without warranty under the terms of the BSD</span>
<span class="c1"># license included in LICENSE.txt and may be redistributed only under</span>
<span class="c1"># the conditions described in the aforementioned license. The license</span>
<span class="c1"># is also available online at http://www.enthought.com/licenses/BSD.txt</span>
<span class="c1">#</span>
<span class="c1"># Thanks for using Enthought open source!</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base class providing common pieces of the Future machinery.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">traits.api</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Bool</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Enum</span><span class="p">,</span>
    <span class="n">HasStrictTraits</span><span class="p">,</span>
    <span class="n">Property</span><span class="p">,</span>
    <span class="n">provides</span><span class="p">,</span>
    <span class="n">Str</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">traits_futures.future_states</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CANCELLABLE_STATES</span><span class="p">,</span>
    <span class="n">CANCELLED</span><span class="p">,</span>
    <span class="n">CANCELLING</span><span class="p">,</span>
    <span class="n">COMPLETED</span><span class="p">,</span>
    <span class="n">DONE_STATES</span><span class="p">,</span>
    <span class="n">EXECUTING</span><span class="p">,</span>
    <span class="n">FAILED</span><span class="p">,</span>
    <span class="n">FutureState</span><span class="p">,</span>
    <span class="n">WAITING</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">traits_futures.i_future</span> <span class="k">import</span> <span class="n">IFuture</span>


<span class="c1"># These extra states let us detect the error of calling _task_started</span>
<span class="c1"># a second time following cancellation.</span>

<span class="c1">#: Extra internal state: WAITING but not yet initialized. Maps to the</span>
<span class="c1">#: WAITING public state.</span>
<span class="n">_NOT_INITIALIZED</span> <span class="o">=</span> <span class="s2">&quot;not_initialized&quot;</span>

<span class="c1">#: Extra internal state: WAITING and initialized. Maps to the WAITING</span>
<span class="c1">#: public state.</span>
<span class="n">_INITIALIZED</span> <span class="o">=</span> <span class="s2">&quot;initialized&quot;</span>

<span class="c1">#: Extra internal state: CANCELLING before STARTED</span>
<span class="n">_CANCELLING_BEFORE_STARTED</span> <span class="o">=</span> <span class="s2">&quot;cancelling_before_started&quot;</span>

<span class="c1">#: Extra internal state: CANCELLING after STARTED</span>
<span class="n">_CANCELLING_AFTER_STARTED</span> <span class="o">=</span> <span class="s2">&quot;cancelling_after_started&quot;</span>


<span class="c1">#: Trait type representing the internal state. The internal state maps</span>
<span class="c1">#: directly to the user-facing state, but splits some of the user-facing</span>
<span class="c1">#: states to provide more information, which can then be used in internal</span>
<span class="c1">#: self-consistency checks. In particular, the user-facing CANCELLING state</span>
<span class="c1">#: is split into substates _CANCELLING_BEFORE_STARTED and</span>
<span class="c1">#: _CANCELLING_AFTER_STARTED, while the user-facing WAITING state is split</span>
<span class="c1">#: into _NOT_INITIALIZED and _INITIALIZED states.</span>
<span class="n">_InternalState</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span>
    <span class="n">_NOT_INITIALIZED</span><span class="p">,</span>
    <span class="n">_INITIALIZED</span><span class="p">,</span>
    <span class="n">EXECUTING</span><span class="p">,</span>
    <span class="n">COMPLETED</span><span class="p">,</span>
    <span class="n">FAILED</span><span class="p">,</span>
    <span class="n">_CANCELLING_BEFORE_STARTED</span><span class="p">,</span>
    <span class="n">_CANCELLING_AFTER_STARTED</span><span class="p">,</span>
    <span class="n">CANCELLED</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_state_from_internal_state</span><span class="p">(</span><span class="n">internal_state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an internal state to the corresponding future state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">internal_state</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">_CANCELLING_AFTER_STARTED</span><span class="p">,</span>
        <span class="n">_CANCELLING_BEFORE_STARTED</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">CANCELLING</span>
    <span class="k">elif</span> <span class="n">internal_state</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_NOT_INITIALIZED</span><span class="p">,</span> <span class="n">_INITIALIZED</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">WAITING</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">internal_state</span>


<span class="c1">#: Exception used to indicate a bad state transition. This should</span>
<span class="c1">#: never happen as a result of user error, only as a result of</span>
<span class="c1">#: a coding error in this repository.</span>
<span class="k">class</span> <span class="nc">_StateTransitionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="BaseFuture"><a class="viewcode-back" href="../../api/traits_futures.base_future.html#traits_futures.base_future.BaseFuture">[docs]</a><span class="nd">@provides</span><span class="p">(</span><span class="n">IFuture</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BaseFuture</span><span class="p">(</span><span class="n">HasStrictTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience base class for the various flavours of Future.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: The state of the background task, to the best of the knowledge of</span>
    <span class="c1">#: this future. One of the six constants ``WAITING``, ``EXECUTING``,</span>
    <span class="c1">#: ``COMPLETED``, ``FAILED``, ``CANCELLING`` or ``CANCELLED``.</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">FutureState</span><span class="p">)</span>

    <span class="c1">#: True if cancellation of the background task can be requested, else</span>
    <span class="c1">#: False. Cancellation of the background task can be requested only if</span>
    <span class="c1">#: the future&#39;s ``state`` is either ``WAITING`` or ``EXECUTING``.</span>
    <span class="n">cancellable</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Bool</span><span class="p">())</span>

    <span class="c1">#: True when communications from the background task are complete.</span>
    <span class="c1">#: At that point, no further state changes can occur for this future.</span>
    <span class="c1">#: This trait has value True if the ``state`` is one of ``COMPLETED``,</span>
    <span class="c1">#: ``FAILED``, or ``CANCELLED``. It&#39;s safe to listen to this trait</span>
    <span class="c1">#: for changes: it will always fire exactly once, and when it fires</span>
    <span class="c1">#: it will be consistent with the ``state``.</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">Bool</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Result of the background task.</span>

<span class="sd">        This attribute is only available if the state of the future is</span>
<span class="sd">        ``COMPLETED``. If the future has not reached the ``COMPLETED`` state,</span>
<span class="sd">        any attempt to access this attribute will raise an ``AttributeError``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : object</span>
<span class="sd">            The result obtained from the background task.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If the task is still executing, or was cancelled, or raised an</span>
<span class="sd">            exception instead of returning a result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">COMPLETED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;No result available. Task has not yet completed, &quot;</span>
                <span class="s2">&quot;or was cancelled, or failed with an exception. &quot;</span>
                <span class="s2">&quot;Task state is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Information about any exception raised by the background task.</span>

<span class="sd">        This attribute is only available if the state of this future is</span>
<span class="sd">        ``FAILED``. If the future has not reached the ``FAILED`` state, any</span>
<span class="sd">        attempt to access this attribute will raise an ``AttributeError.``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        exc_info : tuple(str, str, str)</span>
<span class="sd">            Tuple containing exception information in string form:</span>
<span class="sd">            (exception type, exception value, formatted traceback).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If the task is still executing, or was cancelled, or completed</span>
<span class="sd">            without raising an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FAILED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;No exception information available. Task has &quot;</span>
                <span class="s2">&quot;not yet completed, or was cancelled, or completed &quot;</span>
                <span class="s2">&quot;without an exception. &quot;</span>
                <span class="s2">&quot;Task state is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span>

<div class="viewcode-block" id="BaseFuture.cancel"><a class="viewcode-back" href="../../api/traits_futures.base_future.html#traits_futures.base_future.BaseFuture.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request cancellation of the background task.</span>

<span class="sd">        A task in ``WAITING`` or ``EXECUTING`` state will immediately be moved</span>
<span class="sd">        to ``CANCELLING`` state. If the task is not in ``WAITING`` or</span>
<span class="sd">        ``EXECUTING`` state, this function will raise ``RuntimeError``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the task has already completed or cancellation has already</span>
<span class="sd">            been requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancellable</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Can only cancel a waiting or executing task. &quot;</span>
                <span class="s2">&quot;Task state is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_cancelled</span><span class="p">()</span></div>

    <span class="c1"># Semi-private methods ####################################################</span>

    <span class="c1"># These methods represent the state transitions in response to external</span>
    <span class="c1"># events. They&#39;re used by the FutureWrapper, but are not intended for use</span>
    <span class="c1"># by the users of Traits Futures.</span>

    <span class="k">def</span> <span class="nf">_dispatch_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automate dispatch of different types of message.</span>

<span class="sd">        This is a convenience function, and may be safely overridden by</span>
<span class="sd">        subclasses that want to use a different dispatch mechanism. For</span>
<span class="sd">        a message type ``msgtype``, it looks for a method called</span>
<span class="sd">        ``_process_&lt;msgtype&gt;`` and dispatches the message arguments to</span>
<span class="sd">        that method. Subclasses then only need to provide the appropriate</span>
<span class="sd">        ``_process_&lt;msgtype&gt;`` methods.</span>

<span class="sd">        If the future is already in ``CANCELLING`` state, no message is</span>
<span class="sd">        dispatched.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : tuple(str, object)</span>
<span class="sd">            Message from the background task, in the form (message_type,</span>
<span class="sd">            message_args).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_CANCELLING_AFTER_STARTED</span><span class="p">:</span>
            <span class="c1"># Ignore messages that arrive after a cancellation request.</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">EXECUTING</span><span class="p">:</span>
            <span class="n">message_type</span><span class="p">,</span> <span class="n">message_arg</span> <span class="o">=</span> <span class="n">message</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;_process_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message_type</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)(</span><span class="n">message_arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_StateTransitionError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected custom message in state </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_task_started</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">none</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update state when the background task has started processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_INITIALIZED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">EXECUTING</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_CANCELLING_BEFORE_STARTED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_CANCELLING_AFTER_STARTED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_StateTransitionError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected &#39;started&#39; message in state </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_task_returned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update state when background task reports completing successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">EXECUTING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">COMPLETED</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_CANCELLING_AFTER_STARTED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CANCELLED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_StateTransitionError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected &#39;returned&#39; message in state </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_task_raised</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update state when the background task reports completing with an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">EXECUTING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="n">exception_info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">FAILED</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_CANCELLING_AFTER_STARTED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">CANCELLED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_StateTransitionError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected &#39;raised&#39; message in state </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_user_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update state when the user requests cancellation.</span>

<span class="sd">        A future in ``WAITING`` or ``EXECUTING`` state moves to ``CANCELLING``</span>
<span class="sd">        state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_INITIALIZED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_CANCELLING_BEFORE_STARTED</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">EXECUTING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_CANCELLING_AFTER_STARTED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_StateTransitionError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected &#39;cancelled&#39; message in state </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_executor_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cancel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update state when the executor initializes the future.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cancel : callable</span>
<span class="sd">            The callback to be called when the user requests cancellation.</span>
<span class="sd">            The callback accepts no arguments, and has no return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_NOT_INITIALIZED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel</span> <span class="o">=</span> <span class="n">cancel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_INITIALIZED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_StateTransitionError</span><span class="p">(</span>
                <span class="s2">&quot;Unexpected initialization in state </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Private traits ##########################################################</span>

    <span class="c1">#: Callback called (with no arguments) when user requests cancellation.</span>
    <span class="c1">#: This is reset to ``None`` once cancellation is impossible.</span>
    <span class="n">_cancel</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#: The internal state of the future.</span>
    <span class="n">_state</span> <span class="o">=</span> <span class="n">_InternalState</span>

    <span class="c1">#: Result from the background task.</span>
    <span class="n">_result</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span>

    <span class="c1">#: Exception information from the background task.</span>
    <span class="n">_exception</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">Str</span><span class="p">(),</span> <span class="n">Str</span><span class="p">(),</span> <span class="n">Str</span><span class="p">())</span>

    <span class="c1"># Private methods #########################################################</span>

    <span class="k">def</span> <span class="nf">_get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_state_from_internal_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cancellable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_state_from_internal_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CANCELLABLE_STATES</span>

    <span class="k">def</span> <span class="nf">_get_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_state_from_internal_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span> <span class="ow">in</span> <span class="n">DONE_STATES</span>

    <span class="k">def</span> <span class="nf">__state_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old__state</span><span class="p">,</span> <span class="n">new__state</span><span class="p">):</span>
        <span class="n">old_state</span> <span class="o">=</span> <span class="n">_state_from_internal_state</span><span class="p">(</span><span class="n">old__state</span><span class="p">)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">_state_from_internal_state</span><span class="p">(</span><span class="n">new__state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_state</span> <span class="o">!=</span> <span class="n">new_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>

        <span class="n">old_cancellable</span> <span class="o">=</span> <span class="n">old_state</span> <span class="ow">in</span> <span class="n">CANCELLABLE_STATES</span>
        <span class="n">new_cancellable</span> <span class="o">=</span> <span class="n">new_state</span> <span class="ow">in</span> <span class="n">CANCELLABLE_STATES</span>
        <span class="k">if</span> <span class="n">old_cancellable</span> <span class="o">!=</span> <span class="n">new_cancellable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span>
                <span class="s2">&quot;cancellable&quot;</span><span class="p">,</span> <span class="n">old_cancellable</span><span class="p">,</span> <span class="n">new_cancellable</span>
            <span class="p">)</span>

        <span class="n">old_done</span> <span class="o">=</span> <span class="n">old_state</span> <span class="ow">in</span> <span class="n">DONE_STATES</span>
        <span class="n">new_done</span> <span class="o">=</span> <span class="n">new_state</span> <span class="ow">in</span> <span class="n">DONE_STATES</span>
        <span class="k">if</span> <span class="n">old_done</span> <span class="o">!=</span> <span class="n">new_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trait_property_changed</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">,</span> <span class="n">old_done</span><span class="p">,</span> <span class="n">new_done</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/img/e-logo.png" alt="Logo">
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright (C) Copyright 2018-2020 Enthought, Inc., Austin, TX
All rights reserved.

This software is provided without warranty under the terms of the BSD
license included in LICENSE.txt and may be redistributed only under
the conditions described in the aforementioned license. The license
is also available online at http://www.enthought.com/licenses/BSD.txt

Thanks for using Enthought open source!

      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.3.1.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>